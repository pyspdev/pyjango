<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Hub - Persistente</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define la fuente Inter */
        body { font-family: 'Inter', sans-serif; }
    </style>

    <!-- Carga de Librerías de React y Babel (para transpilar el JSX) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Carga de Módulos de Firebase (v11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importamos todas las funciones necesarias para que el módulo las conozca
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuración de Firestore
        setLogLevel('debug'); 

        // Variables globales (proporcionadas por el entorno de Canvas)
        // Normalizamos el appId para asegurarnos de que no contenga barras extras
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const safeAppId = rawAppId.replace(/[^a-zA-Z0-9_-]/g, '_'); // Reemplaza caracteres inválidos por guiones bajos
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        
        // Función de inicialización asíncrona para asegurar la autenticación
        window.initializeFirebaseApp = async () => {
            try {
                if (!Object.keys(firebaseConfig).length) {
                    throw new Error("La configuración de Firebase está vacía o es inválida.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Manejo de autenticación con el token inicial
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Si no hay token, se autentica de forma anónima
                    await signInAnonymously(auth);
                }

                // 2. Esperar a que el usuario esté autenticado y listo
                return new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            console.log("Firebase Auth listo. UID:", user.uid);
                            // Asigna las instancias y variables al objeto global para que React las use
                            // IMPORTANTE: Exportamos las funciones modulares a 'firestoreOps'
                            window.firebaseAppInstances = { 
                                db, 
                                auth, 
                                userId: user.uid, 
                                appId: safeAppId, // Usamos el appId seguro
                                firestoreOps: {
                                    collection, query, orderBy, addDoc, serverTimestamp, onSnapshot
                                }
                            };
                            unsubscribe();
                            resolve(true);
                        } else if (!initialAuthToken) {
                             // Si estamos anónimos y listos, también resolvemos.
                            // IMPORTANTE: Exportamos las funciones modulares a 'firestoreOps'
                            window.firebaseAppInstances = { 
                                db, 
                                auth, 
                                userId: null, 
                                appId: safeAppId, // Usamos el appId seguro
                                firestoreOps: {
                                    collection, query, orderBy, addDoc, serverTimestamp, onSnapshot
                                }
                            };
                            unsubscribe();
                            resolve(true);
                        }
                    });
                });
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                window.firebaseAppInstances = { error: error.message };
                return false;
            }
        };
    </script>
</head>
<body>
    <div id="react-root">
        <!-- Indicador de carga inicial antes de que React se monte -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center p-10 text-gray-500">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-3"></div>
                Inicializando servicios de datos...
            </div>
        </div>
    </div>

    <!-- Script de la aplicación Data Hub con React. Utiliza type="text/babel" para transpilar. -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Define la estructura del Dataset
        const DatasetItem = ({ id, name, description, createdAt }) => (
            <div className="bg-white p-5 rounded-xl shadow-md flex justify-between items-center transition duration-200 hover:shadow-lg border-l-4 border-green-500">
                <div>
                    <h3 className="text-xl font-bold text-gray-900">{name}</h3>
                    <p className="text-sm text-gray-500 mt-1">{description}</p>
                    <p className="text-xs text-gray-400 mt-1">
                        ID: <span className="font-mono bg-gray-100 px-1 rounded">{id}</span>
                    </p>
                    {createdAt && (
                        <p className="text-xs text-gray-400 mt-1">
                            Creado: {new Date(createdAt.seconds * 1000).toLocaleString('es-ES')}
                        </p>
                    )}
                </div>
                <button
                    className="text-sm text-blue-500 hover:text-blue-700 font-semibold transition duration-150"
                >
                    Ver Detalle &rarr;
                </button>
            </div>
        );

        function App() {
          const [datasets, setDatasets] = useState([]);
          const [newDatasetName, setNewDatasetName] = useState('');
          const [isLoading, setIsLoading] = useState(true);
          const [isReady, setIsReady] = useState(false);
          const [error, setError] = useState(null);
          const [firebaseContext, setFirebaseContext] = useState(null);

          // 1. Inicialización de Firebase y Auth
          useEffect(() => {
            // Llama a la función global para inicializar y autenticar
            if (window.initializeFirebaseApp) {
                window.initializeFirebaseApp().then(() => {
                    const ctx = window.firebaseAppInstances;
                    if (ctx && !ctx.error) {
                        setFirebaseContext(ctx);
                        setIsReady(true);
                    } else if (ctx && ctx.error) {
                        setError(`Error de inicialización: ${ctx.error}`);
                    } else {
                        setError("Fallo la inicialización de servicios desconocida.");
                    }
                    setIsLoading(false);
                });
            } else {
                setError("El script de inicialización de Firebase no cargó correctamente.");
                setIsLoading(false);
            }
          }, []);

          // 2. Carga y Escucha de Datos en Tiempo Real (onSnapshot)
          useEffect(() => {
            if (!isReady || !firebaseContext || error) return;

            // Obtenemos el appId limpio desde el contexto
            const { db, userId, appId, firestoreOps } = firebaseContext;
            // Desestructuramos las funciones de Firestore necesarias
            const { collection, query, orderBy, onSnapshot } = firestoreOps; 
            
            // Si el userId es nulo (por ejemplo, fallo en signInAnonymously), obtenemos el UID actual
            let currentUserId = userId;
            if (!currentUserId && firebaseContext.auth.currentUser) {
                currentUserId = firebaseContext.auth.currentUser.uid;
            }
            
            // Ruta de la colección: /artifacts/{appId}/users/{userId}/datasets
            // Usamos el currentUserId para la ruta. Si es null, usamos la ruta pública.
            const path = currentUserId 
                ? `artifacts/${appId}/users/${currentUserId}/datasets`
                : `artifacts/${appId}/public/data/datasets`;

            try {
              // Usamos la función collection desestructurada
              const datasetsRef = collection(db, path); 

              // Query para ordenar los datos
              const q = query(datasetsRef, orderBy('createdAt', 'desc'));

              // Usamos la función onSnapshot desestructurada
              const unsubscribe = onSnapshot(q, (snapshot) => {
                  const loadedDatasets = snapshot.docs.map(doc => ({
                      id: doc.id,
                      ...doc.data()
                  }));
                  setDatasets(loadedDatasets);
                  setIsLoading(false);
              }, (err) => {
                  console.error("Error al escuchar Firestore:", err);
                  setError("Error de conexión con Firestore. Revisa las reglas de seguridad: " + err.message);
                  setIsLoading(false);
              });

              return () => unsubscribe(); // Limpieza de la suscripción
            } catch (e) {
              console.error("Error al configurar onSnapshot:", e);
              setError("Error crítico de la aplicación: " + e.message);
              setIsLoading(false);
            }
          }, [isReady, error, firebaseContext]); 

          // 3. Función para Agregar un Nuevo Dataset
          const handleAddDataset = async (e) => {
            e.preventDefault();
            const trimmedName = newDatasetName.trim();
            if (!trimmedName || !isReady) return;

            // Obtenemos el appId limpio desde el contexto
            const { db, userId, appId, firestoreOps } = firebaseContext;
            // Desestructuramos las funciones de Firestore necesarias
            const { collection, addDoc, serverTimestamp } = firestoreOps;
            
            let currentUserId = userId;
            if (!currentUserId && firebaseContext.auth.currentUser) {
                currentUserId = firebaseContext.auth.currentUser.uid;
            }

            if (!db || !currentUserId) {
                return setError("El servicio de base de datos no está listo o el usuario no está autenticado.");
            }

            // Ruta de la colección. Aquí solo necesitamos la ruta privada para escribir.
            const path = `artifacts/${appId}/users/${currentUserId}/datasets`;

            try {
              // Usamos las funciones desestructuradas
              const datasetsRef = collection(db, path);
              
              await addDoc(datasetsRef, {
                name: trimmedName,
                description: `Datos para el proyecto ${trimmedName}.`,
                createdAt: serverTimestamp()
              });
              setNewDatasetName('');
            } catch (e) {
              console.error("Error al añadir documento:", e);
              setError("No se pudo agregar el dataset. Verifica permisos o conexión.");
            }
          };

          // 4. Renderizado de la UI
          if (error) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-red-100 p-4">
                <div className="bg-white p-6 rounded-lg shadow-xl border-t-4 border-red-500 text-center max-w-lg mx-auto">
                  <h2 className="text-2xl font-bold text-red-700 mb-2">Error de Conexión</h2>
                  <p className="text-gray-600">{error}</p>
                </div>
              </div>
            );
          }

          if (isLoading || !isReady) {
              return (
                <div className="flex items-center justify-center min-h-screen bg-gray-50 p-4 sm:p-8 font-sans">
                    <div className="text-center p-8 bg-white rounded-xl shadow-lg">
                      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-3"></div>
                      <p className="text-blue-500">Cargando Data Hub...</p>
                    </div>
                </div>
              );
          }
          
          let displayUserId = 'Anónimo (Sin token inicial)';
          if (firebaseContext.auth.currentUser) {
              displayUserId = firebaseContext.auth.currentUser.uid;
          }

          return (
            <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-sans">
              <div className="max-w-4xl mx-auto">
                
                {/* Encabezado */}
                <header className="text-center mb-8">
                  <h1 className="text-4xl font-extrabold text-blue-700">Data Hub Central</h1>
                  <p className="text-gray-500 mt-2">Gestión en Tiempo Real de tus Colecciones de Datos (React + Firestore).</p>
                  <p className="text-xs text-gray-400 mt-2">
                    ID de Usuario: <span className="font-mono bg-gray-200 px-2 py-1 rounded-md text-gray-700">{displayUserId}</span>
                  </p>
                </header>

                {/* Formulario de Adición */}
                <section className="bg-white p-6 rounded-xl shadow-lg mb-8">
                  <h2 className="text-xl font-semibold text-gray-800 mb-4">Añadir Nuevo Dataset</h2>
                  <form onSubmit={handleAddDataset} className="flex flex-col sm:flex-row gap-4">
                    <input
                      type="text"
                      placeholder="Nombre del nuevo dataset (Ej: Proyectos Q4)"
                      value={newDatasetName}
                      onChange={(e) => setNewDatasetName(e.target.value)}
                      className="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                      disabled={!isReady}
                    />
                    <button
                      type="submit"
                      className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 disabled:opacity-50"
                      disabled={!isReady || !newDatasetName.trim()}
                    >
                      Añadir Dataset
                    </button>
                  </form>
                </section>

                {/* Lista de Datasets */}
                <section>
                  <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Datasets Activos ({datasets.length})</h2>
                  
                  {isLoading && datasets.length === 0 && (
                    <div className="text-center p-8 bg-white rounded-xl shadow-lg">
                      <div className="animate-pulse text-blue-500">Cargando datos de Firestore...</div>
                    </div>
                  )}

                  {!isLoading && datasets.length === 0 && (
                    <div className="text-center p-8 bg-white rounded-xl shadow-lg border-l-4 border-yellow-500">
                      <p className="text-yellow-700 font-semibold">No hay datasets. ¡Añade el primero!</p>
                    </div>
                  )}

                  <div className="space-y-4">
                    {datasets.map((dataset) => (
                      <DatasetItem key={dataset.id} {...dataset} />
                    ))}
                  </div>
                </section>
              </div>
            </div>
          );
        }

        // Montar la aplicación React en el DOM
        const root = ReactDOM.createRoot(document.getElementById('react-root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
